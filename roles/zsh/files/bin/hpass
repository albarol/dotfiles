#!/usr/bin/env python3

import argparse
import sys
import hashlib
import getpass


def main(argv=None):
  parser = argparse.ArgumentParser(
    prog="hpass",
    description="Hash password generator",
    epilog=""
  )

  subparsers = parser.add_subparsers(required=True)

  user_cmd = subparsers.add_parser('user')
  user_cmd.add_argument('--dns', required=True, help="dns name; e.g: google.com")
  user_cmd.add_argument('--size', default=10, type=int, help="name size")
  user_cmd.set_defaults(func=exec_user)

  passw_cmd = subparsers.add_parser('pass')
  passw_cmd.add_argument('--dns', required=True, help="dns name; e.g: google.com")
  passw_cmd.add_argument('-c', '--complexity', choices=["basic", "medium", "complex"], default="basic", help="password complexity")
  passw_cmd.add_argument('-u', '--uppercase', action="store_true", dest="has_uppercase", help="include uppercase")
  passw_cmd.add_argument('-x', '--special', action="store_true", dest="special", help="include special characters")
  passw_cmd.set_defaults(func=exec_password)

  try:
    args = parser.parse_args(argv[1:] or ['-h'])
    args.func(args)
  except (TypeError, KeyboardInterrupt):
    parser.print_help()


def exec_user(args):
  user = args.dns.encode('utf8')
  user = hashlib.sha1(user).hexdigest()
  print(user[:args.size])


def exec_password(args):
  complexity = {"basic": 12, "medium": 24, "complex": 40}
  size = complexity[args.complexity]

  passw = getpass.getpass(prompt="Master password: ")
  passw = passw.encode('utf8')
  passw = hashlib.sha1(passw).hexdigest()

  if args.special:
    symbols = ["*", "!"]
    result = []
    for idx, letter in enumerate(passw):
      if idx > 0 and idx % 3 == 0:
        letter = symbols[idx & 1]
      result.append(letter)
    passw = ''.join(result)

  if args.has_uppercase:
    chars = ["a", "e"]
    result = []
    for letter in passw:
      letter = letter.upper() if letter in chars else letter
      result.append(letter)
    passw = ''.join(result)

  print(passw[:size])


if __name__ == '__main__':
  main(sys.argv)